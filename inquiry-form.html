<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Inquiry - TES Property</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .form-container {
      max-width: 800px;
      margin: 3rem auto;
    }
    
    .form-card {
      background-color: var(--white);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    
    .property-preview {
      background-color: var(--gray-100);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .property-preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: var(--border-radius);
    }
    
    .property-preview-info h3 {
      margin-bottom: 0.5rem;
    }
    
    .required {
      color: var(--danger-color);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="container">
      <div class="navbar">
        <a href="index.html" class="navbar-brand">üè† TES Property</a>
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <ul class="navbar-menu">
          <li><a href="index.html">Properties</a></li>
          <li><a href="how-to-inquire.html">How to Inquire</a></li>
          <li><a href="index.html#contact">Contact</a></li>
          <li><a href="shared/login.html" class="btn btn-primary btn-sm">Login</a></li>
        </ul>
      </div>
    </div>
  </nav>
  
  <!-- Inquiry Form -->
  <div class="container form-container">
    <a href="index.html" class="btn btn-outline" style="margin-bottom: 2rem;">
      ‚Üê Back to Properties
    </a>
    
    <div class="form-card">
      <h1>Submit Property Inquiry</h1>
      <p class="text-muted" style="margin-bottom: 2rem;">
        Fill out the form below and our agent will contact you within 24 hours.
      </p>
      
      <!-- Property Preview -->
      <div id="propertyPreview" class="property-preview" style="display: none;">
        <!-- Property info will be loaded here -->
      </div>
      
      <form id="inquiryForm">
        <!-- Property Selection -->
        <div class="form-group">
          <label for="propertyId">Property <span class="required">*</span></label>
          <select id="propertyId" name="propertyId" required>
            <option value="">Select a property</option>
          </select>
        </div>
        
        <!-- Customer Information -->
        <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Your Information</h3>
        
        <div class="grid grid-cols-2">
          <div class="form-group">
            <label for="firstName">First Name <span class="required">*</span></label>
            <input type="text" id="firstName" name="firstName" required>
          </div>
          
          <div class="form-group">
            <label for="lastName">Last Name <span class="required">*</span></label>
            <input type="text" id="lastName" name="lastName" required>
          </div>
        </div>
        
        <div class="grid grid-cols-2">
          <div class="form-group">
            <label for="email">Email Address <span class="required">*</span></label>
            <input type="email" id="email" name="email" required>
            <div class="form-error" id="emailError"></div>
          </div>
          
          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" placeholder="0917-123-4567" required>
            <div class="form-error" id="phoneError"></div>
          </div>
        </div>
        
        <div class="grid grid-cols-2">
          <div class="form-group">
            <label for="preferredContact">Preferred Contact Method <span class="required">*</span></label>
            <select id="preferredContact" name="preferredContact" required>
              <option value="SMS">SMS</option>
              <option value="Email">Email</option>
              <option value="Messenger">Messenger</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="numberOfGuests">Number of Guests for Viewing</label>
            <input type="number" id="numberOfGuests" name="numberOfGuests" min="1" max="10" value="1">
          </div>
        </div>
        
        <div class="form-group">
          <label for="message">Message <span class="required">*</span></label>
          <textarea id="message" name="message" rows="4" placeholder="Tell us about your requirements and preferred viewing schedule..." required></textarea>
        </div>
        
        <div class="form-group">
          <label for="notes">Additional Notes (Optional)</label>
          <textarea id="notes" name="notes" rows="3" placeholder="Any other information you'd like to share..."></textarea>
        </div>
        
        <div style="margin-top: 2rem;">
          <button type="submit" class="btn btn-primary btn-lg">Submit Inquiry</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Success Modal -->
  <div id="successModal" class="modal">
    <div class="modal-content">
      <div style="text-align: center;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
        <h2>Inquiry Submitted Successfully!</h2>
        <p class="text-muted" style="margin: 1.5rem 0;">
          Thank you for your inquiry. Our agent will contact you within 24 hours to schedule a viewing.
        </p>
        <a href="index.html" class="btn btn-primary">Back to Properties</a>
      </div>
    </div>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/utils.js"></script>
  <script>
    let selectedProperty = null;
    let allProperties = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      initNavigation('customer');
      
      if (initializeFirebase()) {
        loadProperties();
        setupFormValidation();
        
        // Check if property ID is in URL
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('propertyId');
        if (propertyId) {
          document.getElementById('propertyId').value = propertyId;
          setTimeout(() => updatePropertyPreview(), 500);
        }
      } else {
        showAlert('Unable to connect to database', 'danger');
      }
    });
    
    function loadProperties() {
      const propertiesRef = getPropertiesRef();
      
      propertiesRef.once('value', (snapshot) => {
        const data = snapshot.val();
        const select = document.getElementById('propertyId');
        
        if (data) {
          Object.keys(data).forEach(key => {
            const property = data[key];
            // Only show available properties
            if (property.status === 'Available' || property.status === 'Reserved' || property.status === 'Pending') {
              allProperties.push(property);
              const option = document.createElement('option');
              option.value = property.id;
              option.textContent = `${property.name} - ${formatPHP(property.price)}`;
              select.appendChild(option);
            }
          });
        }
        
        // Update preview if property was pre-selected
        const urlParams = new URLSearchParams(window.location.search);
        const propertyId = urlParams.get('propertyId');
        if (propertyId) {
          select.value = propertyId;
          updatePropertyPreview();
        }
      });
    }
    
    function updatePropertyPreview() {
      const propertyId = document.getElementById('propertyId').value;
      const preview = document.getElementById('propertyPreview');
      
      if (!propertyId) {
        preview.style.display = 'none';
        return;
      }
      
      selectedProperty = allProperties.find(p => p.id == propertyId);
      
      if (selectedProperty) {
        const photo = selectedProperty.photos && selectedProperty.photos[0] 
          ? selectedProperty.photos[0].url 
          : 'https://via.placeholder.com/100x100?text=Property';
        
        preview.style.display = 'flex';
        preview.innerHTML = `
          <img src="${photo}" alt="${selectedProperty.name}">
          <div class="property-preview-info">
            <h3>${selectedProperty.name}</h3>
            <p class="text-muted" style="margin-bottom: 0.5rem;">${formatAddress(selectedProperty.address)}</p>
            <p style="font-size: 1.25rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0;">
              ${formatPHP(selectedProperty.price)}
            </p>
          </div>
        `;
      }
    }
    
    function setupFormValidation() {
      document.getElementById('propertyId').addEventListener('change', updatePropertyPreview);
      
      document.getElementById('email').addEventListener('blur', function() {
        const email = this.value.trim();
        const errorDiv = document.getElementById('emailError');
        
        if (email && !validateEmail(email)) {
          errorDiv.textContent = 'Please enter a valid email address';
        } else {
          errorDiv.textContent = '';
        }
      });
      
      document.getElementById('phone').addEventListener('blur', function() {
        const phone = this.value.trim();
        const errorDiv = document.getElementById('phoneError');
        
        if (phone && !validatePhoneNumber(phone)) {
          errorDiv.textContent = 'Please enter a valid Philippine phone number (e.g., 0917-123-4567)';
        } else {
          errorDiv.textContent = '';
          // Format phone number
          this.value = formatPhoneNumber(phone);
        }
      });
      
      document.getElementById('inquiryForm').addEventListener('submit', handleSubmit);
    }
    
    async function handleSubmit(e) {
      e.preventDefault();
      
      const formData = {
        propertyId: document.getElementById('propertyId').value,
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        email: document.getElementById('email').value.trim().toLowerCase(),
        phone: formatPhoneNumber(document.getElementById('phone').value.trim()),
        preferredContact: document.getElementById('preferredContact').value,
        numberOfGuests: parseInt(document.getElementById('numberOfGuests').value) || 1,
        message: document.getElementById('message').value.trim(),
        notes: document.getElementById('notes').value.trim()
      };
      
      // Validate
      if (!formData.propertyId) {
        showAlert('Please select a property', 'danger');
        return;
      }
      
      if (!validateEmail(formData.email)) {
        showAlert('Please enter a valid email address', 'danger');
        return;
      }
      
      if (!validatePhoneNumber(formData.phone)) {
        showAlert('Please enter a valid phone number', 'danger');
        return;
      }
      
      // Check for duplicate inquiries
      const isDuplicate = await checkDuplicateInquiry(formData.email, formData.phone, formData.propertyId);
      
      if (isDuplicate) {
        showAlert('You already have an active inquiry for this property. Please wait for our agent to contact you.', 'warning');
        return;
      }
      
      // Submit inquiry
      submitInquiry(formData);
    }
    
    async function checkDuplicateInquiry(email, phone, propertyId) {
      return new Promise((resolve) => {
        const inquiriesRef = getInquiriesRef();
        
        inquiriesRef.once('value', (snapshot) => {
          const data = snapshot.val();
          
          if (!data) {
            resolve(false);
            return;
          }
          
          const activeStatuses = ['New', 'Assigned', 'In Progress', 'Viewing Scheduled', 'Viewed - Interested', 'Viewed - Undecided', 'Deposit Paid'];
          
          const duplicate = Object.keys(data).some(key => {
            const inquiry = data[key];
            return (
              (inquiry.customerEmail.toLowerCase() === email || inquiry.customerPhone === phone) &&
              inquiry.propertyId == propertyId &&
              activeStatuses.includes(inquiry.status)
            );
          });
          
          resolve(duplicate);
        });
      });
    }
    
    function submitInquiry(formData) {
      const inquiriesRef = getInquiriesRef();
      const newInquiryKey = inquiriesRef.push().key;
      const timestamp = new Date().toISOString();
      
      const inquiry = {
        id: Date.now(),
        propertyId: parseInt(formData.propertyId),
        propertyName: selectedProperty.name,
        customerName: `${formData.firstName} ${formData.lastName}`,
        customerEmail: formData.email,
        customerPhone: formData.phone,
        preferredContact: formData.preferredContact,
        numberOfGuests: formData.numberOfGuests,
        message: formData.message,
        notes: formData.notes,
        status: 'New',
        assignedAgentId: null,
        assignedAgentName: null,
        noShowCount: 0,
        createdAt: timestamp,
        statusHistory: [
          {
            status: 'New',
            changedBy: 'system',
            timestamp: timestamp
          }
        ]
      };
      
      inquiriesRef.child(newInquiryKey).set(inquiry)
        .then(() => {
          // Show success modal
          openModal('successModal');
        })
        .catch((error) => {
          console.error('Error submitting inquiry:', error);
          showAlert('Failed to submit inquiry. Please try again.', 'danger');
        });
    }
  </script>
</body>
</html>
