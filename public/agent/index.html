<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Portal - TES Property</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    /* Agent Portal SPA Layout */
    .agent-layout {
      display: flex;
      min-height: 100vh;
    }
    
    .agent-sidebar {
      width: 250px;
      background-color: var(--gray-900);
      color: var(--white);
      padding: 2rem 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .agent-sidebar-brand {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--white);
      padding: 0 1.5rem;
      margin-bottom: 2rem;
      display: block;
    }
    
    .agent-sidebar nav {
      background: none;
      box-shadow: none;
      position: static;
    }
    
    .agent-sidebar ul {
      list-style: none;
      padding: 0;
    }
    
    .agent-sidebar li {
      margin: 0;
    }
    
    .agent-sidebar a {
      display: block;
      padding: 1rem 1.5rem;
      color: var(--gray-300);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .agent-sidebar a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }
    
    .agent-sidebar a.active {
      background-color: var(--primary-color);
      color: var(--white);
      border-radius: 0;
    }
    
    .agent-content {
      margin-left: 250px;
      flex: 1;
      padding: 2rem;
      background-color: var(--gray-100);
    }
    
    .agent-header {
      background-color: var(--white);
      padding: 1rem 2rem;
      margin: -2rem -2rem 2rem -2rem;
      box-shadow: var(--box-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .portal-section {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .portal-section.hidden {
      display: none;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="agent-layout">
    <!-- Sidebar -->
    <aside class="agent-sidebar">
      <a href="#dashboard" class="agent-sidebar-brand">üè† TES Property Agent</a>
      <nav>
        <ul>
          <li><a href="#dashboard" onclick="showSection('dashboard'); return false;">üìä Dashboard</a></li>
          <li><a href="#inquiries" onclick="showSection('inquiries'); return false;">üìã My Inquiries</a></li>
          <li><a href="#calendar" onclick="showSection('calendar'); return false;">üìÖ Calendar</a></li>
          <li><a href="#my-properties" onclick="showSection('my-properties'); return false;">üè† My Properties</a></li>
          <li><a href="#" onclick="logout(); return false;" class="btn btn-danger btn-sm" style="margin: 1rem 1.5rem;">Logout</a></li>
        </ul>
      </nav>
    </aside>
    
    <!-- Main Content Area -->
    <main class="agent-content">
      <div class="agent-header">
        <div>
          <h2 id="page-title">Dashboard</h2>
          <p class="text-muted">Welcome back, <span id="userName">Agent</span></p>
        </div>
        <div>
          <button onclick="refreshCurrentSection()" class="btn btn-outline btn-sm">üîÑ Refresh</button>
        </div>
      </div>
      
      <!-- Dashboard Section -->
      <section id="dashboard" class="portal-section" data-section="dashboard">
        <div style="text-align: center; padding: 3rem;">
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p>Loading dashboard...</p>
        </div>
      </section>
      
      <!-- Inquiries Section -->
      <section id="inquiries" class="portal-section hidden" data-section="inquiries">
        <div style="text-align: center; padding: 3rem;">
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p>Loading inquiries...</p>
        </div>
      </section>
      
      <!-- Calendar Section -->
      <section id="calendar" class="portal-section hidden" data-section="calendar">
        <div style="text-align: center; padding: 3rem;">
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p>Loading calendar...</p>
        </div>
      </section>
      
      <!-- My Properties Section -->
      <section id="my-properties" class="portal-section hidden" data-section="my-properties">
        <div style="text-align: center; padding: 3rem;">
          <div class="spinner" style="margin: 0 auto 1rem;"></div>
          <p>Loading properties...</p>
        </div>
      </section>
    </main>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="../js/firebase-config.js"></script>
  <script src="../js/utils.js"></script>
  <script>
    // Section content cache
    const sectionContent = {};
    const sectionScripts = {};
    let currentUser = null;
    
    // Page titles for each section
    const pageTitles = {
      dashboard: 'My Dashboard',
      inquiries: 'My Inquiries',
      calendar: 'My Calendar',
      'my-properties': 'My Properties'
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication
      if (!checkAuth('agent')) {
        return;
      }
      
      currentUser = getCurrentUser();
      document.getElementById('userName').textContent = currentUser.name;
      
      // Load initial section based on hash or default to dashboard
      const hash = window.location.hash.substring(1) || 'dashboard';
      showSection(hash);
      
      // Handle browser back/forward buttons
      window.addEventListener('hashchange', () => {
        const newHash = window.location.hash.substring(1) || 'dashboard';
        showSection(newHash);
      });
    });
    
    // Show a specific section
    async function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.portal-section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Update active nav link
      document.querySelectorAll('.agent-sidebar a').forEach(link => {
        link.classList.remove('active');
      });
      const activeLink = document.querySelector(`.agent-sidebar a[href="#${sectionId}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
      
      // Update page title
      document.getElementById('page-title').textContent = pageTitles[sectionId] || sectionId;
      
      // Update URL hash (no page reload!)
      window.location.hash = sectionId;
      
      // Show selected section
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.classList.remove('hidden');
        
        // Load content if not already loaded
        if (!sectionContent[sectionId]) {
          await loadSectionContent(sectionId);
        }
      }
    }
    
    // Load section content dynamically
    async function loadSectionContent(sectionId) {
      const targetSection = document.getElementById(sectionId);
      if (!targetSection) return;
      
      try {
        // Fetch the content from the original HTML file
        const response = await fetch(`_${sectionId}.html`);
        if (!response.ok) {
          throw new Error(`Failed to load ${sectionId}`);
        }
        
        const html = await response.text();
        
        // Parse the HTML to extract just the main content (not head, nav, etc.)
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract main content (everything inside body except nav)
        const body = doc.querySelector('body');
        const nav = body.querySelector('nav');
        if (nav) nav.remove();
        
        // Get all content from body
        const content = body.innerHTML;
        
        // Cache the content
        sectionContent[sectionId] = content;
        
        // Insert into section
        targetSection.innerHTML = content;
        
        // Extract and execute scripts
        const scripts = doc.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.src) {
            // External script - only load if not already loaded
            const existingScript = document.querySelector(`script[src="${script.src}"]`);
            if (!existingScript) {
              const newScript = document.createElement('script');
              newScript.src = script.src;
              document.body.appendChild(newScript);
            }
          } else if (script.textContent) {
            // Inline script - wrap in function and execute
            try {
              const scriptFunction = new Function(script.textContent);
              scriptFunction();
            } catch (error) {
              console.error(`Error executing script for ${sectionId}:`, error);
            }
          }
        });
        
      } catch (error) {
        console.error('Error loading section:', error);
        targetSection.innerHTML = `
          <div class="alert alert-danger">
            <strong>Error:</strong> Failed to load ${sectionId} content.
            <button onclick="loadSectionContent('${sectionId}')" class="btn btn-sm btn-primary" style="margin-left: 1rem;">
              Retry
            </button>
          </div>
        `;
      }
    }
    
    // Refresh current section
    function refreshCurrentSection() {
      const hash = window.location.hash.substring(1) || 'dashboard';
      // Clear cache and reload
      sectionContent[hash] = null;
      loadSectionContent(hash);
    }
    
    // Logout function
    function logout() {
      clearCurrentUser();
      window.location.href = '../shared/login.html';
    }
  </script>
</body>
</html>
